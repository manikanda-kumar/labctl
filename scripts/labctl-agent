#!/bin/bash
# labctl-agent - Create and start a custom coding agent playground
# Usage: labctl-agent <playground-name> [--repo <git-url>]

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
TEMPLATE="${SCRIPT_DIR}/templates/coding-agent-custom.yaml.template"

# Find .env file (check current dir, script dir, and parent dirs)
find_env_file() {
    local dir="$PWD"
    while [ "$dir" != "/" ]; do
        if [ -f "$dir/.env" ]; then
            echo "$dir/.env"
            return 0
        fi
        dir=$(dirname "$dir")
    done
    return 1
}

ENV_FILE="$(find_env_file)"

# Parse arguments
if [ $# -lt 1 ]; then
    echo -e "${BLUE}labctl-agent${NC} - Create and start a custom coding agent playground"
    echo ""
    echo "Usage: labctl-agent <playground-name> [--repo <git-url>]"
    echo ""
    echo "Options:"
    echo "  --repo <url>    Auto-clone git repository on start"
    echo ""
    echo "Configuration:"
    echo "  Requires a .env file with the following variables:"
    echo "    ANTHROPIC_API_KEY   - Your Anthropic API key (required)"
    echo "    OPENAI_API_KEY      - Your OpenAI API key (optional)"
    echo "    GITHUB_TOKEN        - Your GitHub personal access token (required)"
    echo ""
    echo "Setup:"
    echo "  1. Copy the example env file:"
    echo "     cp ${SCRIPT_DIR}/.env.example .env"
    echo "  2. Edit .env with your actual API keys"
    echo "  3. Run: labctl-agent my-project"
    echo ""
    echo "Examples:"
    echo "  labctl-agent my-project"
    echo "  labctl-agent my-project --repo https://github.com/user/repo"
    exit 1
fi

PLAYGROUND_NAME="$1"
REPO=""

# Parse optional args
shift
while [[ $# -gt 0 ]]; do
    case $1 in
        --repo)
            REPO="$2"
            shift 2
            ;;
        *)
            echo -e "${RED}Unknown option: $1${NC}" >&2
            exit 1
            ;;
    esac
done

# Check .env file exists
if [ -z "$ENV_FILE" ]; then
    echo -e "${RED}Error: .env file not found!${NC}" >&2
    echo -e "${YELLOW}Create it from the example:${NC}" >&2
    echo "  cp ${SCRIPT_DIR}/.env.example .env" >&2
    echo "  nano .env" >&2
    exit 1
fi

echo -e "${BLUE}Using .env file:${NC} $ENV_FILE"

# Load environment variables from .env
set -a
source "$ENV_FILE"
set +a

# Check required env vars
check_env_var() {
    local var_name="$1"
    if [ -z "${!var_name:-}" ]; then
        echo -e "${RED}Error: $var_name is not set in .env${NC}" >&2
        return 1
    fi
}

echo -e "${BLUE}Checking required variables...${NC}"
check_env_var "ANTHROPIC_API_KEY" || exit 1
check_env_var "GITHUB_TOKEN" || exit 1

# OPENAI_KEY is optional
if [ -z "${OPENAI_API_KEY:-}" ]; then
    echo -e "${YELLOW}Warning: OPENAI_API_KEY not set (optional)${NC}"
fi

# Export for envsubst
export PLAYGROUND_NAME
export ANTHROPIC_KEY="${ANTHROPIC_API_KEY}"
export OPENAI_KEY="${OPENAI_API_KEY:-}"
export GITHUB_TOKEN

# Validate template exists
if [ ! -f "$TEMPLATE" ]; then
    echo -e "${RED}Error: Template not found at $TEMPLATE${NC}" >&2
    exit 1
fi

# Generate manifest
MANIFEST_FILE="/tmp/coding-agent-${PLAYGROUND_NAME}-$$.yaml"
echo -e "${BLUE}Generating manifest from template...${NC}"
envsubst < "$TEMPLATE" > "$MANIFEST_FILE"

# Create playground
echo -e "${BLUE}Creating playground:${NC} $PLAYGROUND_NAME"
if labctl playground create "$PLAYGROUND_NAME" -b coding-agent-base -f "$MANIFEST_FILE" 2>&1; then
    echo -e "${GREEN}✓ Playground created${NC}"
else
    rm -f "$MANIFEST_FILE"
    exit 1
fi

# Clean up manifest
rm -f "$MANIFEST_FILE"

# Start playground
echo -e "${BLUE}Starting playground with SSH access...${NC}"
START_ARGS=("labctl" "playground" "start" "$PLAYGROUND_NAME" "--ssh")

if [ -n "$REPO" ]; then
    START_ARGS+=("--init-condition" "Repository=$REPO")
fi

"${START_ARGS[@]}" 2>&1 || {
    echo -e "${RED}Failed to start playground${NC}" >&2
    exit 1
}

echo ""
echo -e "${GREEN}✓ Playground ready!${NC}"
echo ""
echo -e "${BLUE}Tools installed:${NC}"
echo "  • gh cli (GitHub CLI)"
echo "  • zsh + oh-my-zsh with autosuggestions & syntax highlighting"
echo "  • jq, yq, ripgrep, bat"
echo "  • Tailscale"
echo "  • Chrome (headless)"
echo ""
echo -e "${BLUE}Secrets injected to:${NC}"
echo "  • ~/.config/anthropic/key (mode 0600)"
echo "  • ~/.config/openai/key (mode 0600)"
echo "  • ~/.config/github/token (mode 0600)"
echo ""
echo -e "${BLUE}Access:${NC}"
echo "  • SSH:   labctl ssh $PLAYGROUND_NAME"
echo "  • Web:   Open the playground URL in your browser"
echo ""
